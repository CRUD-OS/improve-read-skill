import { OpenAI } from "openai";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export const generateQuestions = async (
  _: unknown,
  { chapter }: { chapter: string }
) => {
  try {
    if (!process.env.OPENAI_API_KEY) {
      throw new Error("OpenAI API key is not configured");
    }

    if (!chapter || chapter.trim() === "") {
      throw new Error("–¢–µ–∫—Å—Ç —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞");
    }

    const completion = await client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: `
–ß–∏ –±–æ–ª–æ–≤—Å—Ä–æ–ª—ã–Ω —Å–∞–ª–±–∞—Ä—ã–Ω AI —Ç—É—Å–ª–∞—Ö. –ß–∏–Ω–∏–π –∑–æ—Ä–∏–ª–≥–æ –±–æ–ª —Å—É—Ä–∞–≥—á–∏–π–Ω —É–Ω—à—Å–∞–Ω —ç—Ö–∏–π–≥ –æ–π–ª–≥–æ—Å–æ–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö **–∞—Å—É—É–ª—Ç** –±—ç–ª—Ç–≥—ç—Ö —é–º.

–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω ”©–≥—Å”©–Ω —Ç–µ–∫—Å—Ç –¥—ç—ç—Ä “Ø–Ω–¥—ç—Å–ª—ç–Ω –¥–∞—Ä–∞–∞—Ö —à–∞–∞—Ä–¥–ª–∞–≥—ã–≥ —Ö–∞–Ω–≥–∞—Ö **3-5 –∞—Å—É—É–ª—Ç** –±–æ–ª–æ–≤—Å—Ä—É—É–ª:

1. **–ê–≥—É—É–ª–≥—ã–Ω —Ç—É—Ö–∞–π –∞—Å—É—É–ª—Ç** ‚Äî –≥–æ–ª —Å–∞–Ω–∞–∞, —é—É –±–æ–ª—Å–æ–Ω —Ç–∞–ª–∞–∞—Ä.
2. **–®–∞–ª—Ç–≥–∞–∞–Ω, “Ø—Ä –¥–∞–≥–∞–≤—Ä—ã–Ω –∞—Å—É—É–ª—Ç** ‚Äî —è–∞–≥–∞–∞–¥ –∏–π–º –∑“Ø–π–ª –±–æ–ª—Å–æ–Ω —Ç—É—Ö–∞–π.
3. **–î“Ø–≥–Ω—ç–ª—Ç —Ö–∏–π—Ö, ”©”©—Ä–∏–π–Ω –±–∞–π—Ä —Å—É—É—Ä—å –∏–ª—ç—Ä—Ö–∏–π–ª—ç—Ö –∞—Å—É—É–ª—Ç** ‚Äî —Å—É—Ä–∞–≥—á —é—É –≥—ç–∂ –±–æ–¥–æ–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö.
4. **“Æ–≥ —Ö—ç–ª–ª—ç–≥, ”©–≥“Ø“Ø–ª–±—ç—Ä–∏–π–Ω —É—Ç–≥–∞ —Ç–∞–π–ª–±–∞—Ä–ª–∞—Ö –∞—Å—É—É–ª—Ç** (—Ö—ç—Ä–≤—ç—ç —Ç–æ—Ö–∏—Ä–æ–º–∂—Ç–æ–π –±–æ–ª).

üëâ –ê—Å—É—É–ª—Ç –±“Ø—Ä–∏–π–Ω –¥–∞—Ä–∞–∞ —Ç–æ–≤—á, –æ–π–ª–≥–æ–º–∂—Ç–æ–π **—Ç–∞–π–ª–±–∞—Ä** –Ω—ç–º—ç—ç—Ä—ç–π.  
üëâ –ê—Å—É—É–ª—Ç—É—É–¥ –Ω—å –Ω–∞—Å–∞–Ω–¥ —Ç–æ—Ö–∏—Ä—Å–æ–Ω, –±–æ–ª–æ–≤—Å—Ä–æ–ª—ã–Ω –∑–æ—Ä–∏–ª–≥–æ—Ç–æ–π, —ç–Ω–≥–∏–π–Ω –æ–π–ª–≥–æ–º–∂—Ç–æ–π –±–∞–π—Ö —ë—Å—Ç–æ–π.  
üëâ –ì–∞—Ä—á–∏–≥, –æ—Ä—à–∏–ª —Ö—ç—Ä—ç–≥–≥“Ø–π. –ó”©–≤—Ö”©–Ω –∞—Å—É—É–ª—Ç—É—É–¥ –±–æ–ª–æ–Ω —Ç–∞–π–ª–±–∞—Ä—É—É–¥—ã–≥ –∂–∞–≥—Å–∞–∞–ª—Ç–∞–∞—Ä –±—É—Ü–∞–∞.

–ñ–∏—à—ç—ç —Ñ–æ—Ä–º–∞—Ç:
1. [–ê—Å—É—É–ª—Ç?]  
   - –¢–∞–π–ª–±–∞—Ä: [–Ø–∞–≥–∞–∞–¥ —ç–Ω—ç –∞—Å—É—É–ª—Ç —á—É—Ö–∞–ª –≤—ç –≥—ç—Ö –º—ç—Ç...]
`,
        },
        {
          role: "user",
          content: chapter,
        },
      ],
    });

    const result = completion.choices[0]?.message?.content;
    if (!result) throw new Error("AI-–≥–∞–∞—Å —Ö–æ–æ—Å–æ–Ω —Ö–∞—Ä–∏—É –∏—Ä—Å—ç–Ω –±–∞–π–Ω–∞");

    const questions = result
      .split("\n")
      .map((q) => q.trim().replace(/^\d+\.\s*/, ""))
      .filter((q) => q.length > 0);

    return questions;
  } catch (error: any) {
    console.error("OpenAI Error:", error);
    throw new Error(error.message || "–ê—Å—É—É–ª—Ç “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞");
  }
};
